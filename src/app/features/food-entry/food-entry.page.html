<main class="food-entry-page">
  <header class="food-entry-page__header">
    <h1 class="food-entry-page__title" i18n="@@foodEntry.title">Saisie alimentaire v1.3</h1>
  </header>

  <!-- ‚îÄ‚îÄ Formulaire de nouvelle saisie ‚îÄ‚îÄ -->
  <section
    class="food-entry-page__form"
    aria-label="Nouvelle saisie"
    i18n-aria-label="@@foodEntry.form.ariaLabel"
  >
    <gt-meal-type-picker
      [selected]="selectedMealType()"
      (selectedChange)="onMealTypeChange($event)"
    />

    <gt-recent-foods (foodSelected)="onFoodAdded($event)" />

    <!-- ‚îÄ‚îÄ Onglets de mode de saisie ‚îÄ‚îÄ -->
    <div class="food-entry-page__mode-tabs" role="tablist">
      <button
        type="button"
        role="tab"
        class="food-entry-page__mode-tab"
        [class.food-entry-page__mode-tab--active]="entryMode() === 'manual'"
        [attr.aria-selected]="entryMode() === 'manual'"
        (click)="setEntryMode('manual')"
      >
        <span aria-hidden="true">‚úèÔ∏è</span>
        <span i18n="@@foodEntry.mode.manual">Manuel</span>
      </button>
      <button
        type="button"
        role="tab"
        class="food-entry-page__mode-tab"
        [class.food-entry-page__mode-tab--active]="entryMode() === 'camera'"
        [attr.aria-selected]="entryMode() === 'camera'"
        (click)="setEntryMode('camera')"
      >
        <span aria-hidden="true">üì∑</span>
        <span i18n="@@foodEntry.mode.camera">Photo</span>
      </button>
    </div>

    <!-- ‚îÄ‚îÄ Contenu selon le mode actif ‚îÄ‚îÄ -->
    @if (entryMode() === 'camera') {
      @if (recognitionResult(); as result) {
        <gt-food-recognition-result
          [result]="result.recognitionResult"
          [photoUrl]="result.photoUrl"
          (confirmed)="onRecognitionConfirmed($event)"
          (cancelled)="onRecognitionCancelled()"
        />
      } @else {
        <gt-food-camera (analysisComplete)="onRecognitionComplete($event)" />
      }
    } @else {
      <gt-food-search
        [analyzing]="aiAnalyzing()"
        (foodAdded)="onFoodAdded($event)"
        (foodAddedAndAnalyze)="onFoodAddedAndAnalyze($event)"
      />
    }

    @if (pendingFoods().length > 0) {
      <ul
        class="food-entry-page__pending"
        aria-label="Aliments √† enregistrer"
        i18n-aria-label="@@foodEntry.pending.ariaLabel"
      >
        @for (food of pendingFoods(); track food.id) {
          <li class="food-entry-page__pending-item">
            <span class="food-entry-page__pending-name">{{ food.name }}</span>

            @if (food.quantity) {
              <span class="food-entry-page__pending-qty">{{ food.quantity }}</span>
            }

            @if (analyzingFoodIds().has(food.id)) {
              <span class="food-entry-page__pending-analyzing" i18n="@@foodEntry.pending.analyzing">
                Analyse‚Ä¶
              </span>
            } @else if (food.fodmapScore) {
              <gt-fodmap-badge
                [level]="food.fodmapScore.level"
                [score]="food.fodmapScore.score"
              />
            }

            <button
              type="button"
              class="food-entry-page__pending-remove"
              (click)="removePendingFood(food.id)"
              aria-label="Retirer l'aliment"
              i18n-aria-label="@@foodEntry.removeFood.ariaLabel"
            >
              ‚úï
            </button>
          </li>
        }
      </ul>
    }

    <button
      type="button"
      class="food-entry-page__save-btn"
      (click)="saveEntry()"
      [disabled]="!canSave() || saving()"
    >
      @if (aiAnalyzing()) {
        <span i18n="@@foodEntry.analyzingFodmap">Analyse FODMAP‚Ä¶</span>
      } @else if (saving()) {
        <span i18n="@@foodEntry.saving">Enregistrement‚Ä¶</span>
      } @else {
        <span i18n="@@foodEntry.save">Enregistrer le repas</span>
      }
    </button>
  </section>

  <gt-voice-input [context]="'food'" (parseResultReady)="onVoiceResult($event)" />

  <!-- ‚îÄ‚îÄ Journal du jour ‚îÄ‚îÄ -->
  <section
    class="food-entry-page__journal"
    aria-label="Journal du jour"
    i18n-aria-label="@@foodEntry.journal.ariaLabel"
  >
    <h2 class="food-entry-page__journal-title" i18n="@@foodEntry.journal.title">
      Journal du jour
    </h2>

    @if (loading()) {
      <p class="food-entry-page__loading" i18n="@@foodEntry.loading">Chargement‚Ä¶</p>
    } @else if (todayEntries().length === 0) {
      <p class="food-entry-page__empty" i18n="@@foodEntry.empty">
        Aucune saisie aujourd'hui. Commencez par ajouter un repas.
      </p>
    } @else {
      <div class="food-entry-page__entries">
        @for (entry of todayEntries(); track entry.id) {
          <gt-food-entry-card [entry]="entry" />
        }
      </div>
    }
  </section>
</main>
